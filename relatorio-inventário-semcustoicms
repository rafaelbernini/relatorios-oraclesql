SELECT
 CTE.DTCONTAGEM
,CTE.CODEMP
,PRO.NCM
,PRO.DESCRPROD
,CTE.CODPROD
,PRO.AD_PARTNUMBER
,CTE.CODVOL
,CTE.QTDEST
,CUS.CUSSEMICM
,(SELECT NVL(MAX(FCUS.CUSSEMICM), 0)
    FROM TGFCUS FCUS,
    (SELECT MAX(CUS1.DTATUAL)
    FROM TGFCUS CUS1 WHERE CUS1.CODPROD = CTE.CODPROD)
    WHERE FCUS.CODPROD = CTE.CODPROD
    AND FCUS.CODEMP = CTE.CODEMP) AS CUSTO_SEM_ICMS
,(CTE.QTDEST * CUS.CUSSEMICM) AS CUS_SEM_ICMS

,CTE.QTDEST *  (SELECT NVL(MAX(FCUS.CUSSEMICM), 0)
    FROM TGFCUS FCUS,
    (SELECT MAX(CUS1.DTATUAL)
    FROM TGFCUS CUS1 WHERE CUS1.CODPROD = CTE.CODPROD)
    WHERE FCUS.CODPROD = CTE.CODPROD
    AND FCUS.CODEMP = CTE.CODEMP) AS VLR_TOTAL

,CUS.CUSMEDCALC
,CTE.CODLOCAL
,CTE.CODPARC
,CTE.TIPO
FROM
VGFCTE CTE
LEFT JOIN (SELECT CODPROD, MAX(DTATUAL) DATA FROM TGFCUS GROUP BY CODPROD) CUS1
    ON CTE.CODPROD = CUS1.CODPROD
LEFT OUTER JOIN TGFPRO PRO ON (PRO.CODPROD = CTE.CODPROD)
LEFT OUTER JOIN TGFCUS CUS ON (CTE.CODEMP = CUS.CODEMP AND CUS1.DATA = CUS.DTATUAL AND CUS1.CODPROD = CUS.CODPROD)
WHERE CTE.CODEMP = 101
AND CTE.DTCONTAGEM = TO_DATE('30/11/2020','DD/MM/YYYY')
AND CTE.TIPO ='P' AND (PRO.CODGRUPOPROD >= 30101000 AND PRO.CODGRUPOPROD <= 31601000)
